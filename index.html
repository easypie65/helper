<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교사 상담 도우미</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
            color: #334155;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 95%;
            background-color: #fff;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-8 bg-white rounded-3xl shadow-lg">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-blue-800 mb-2">교사 상담 도우미</h1>
        <p class="text-center text-gray-500 mb-8 text-base sm:text-lg">학생의 특성을 입력하여 맞춤형 상담 조언을 받아보세요.</p>

        <!-- 교사 모드 섹션 -->
        <div id="teacher-mode-section">
             <h2 class="text-xl font-semibold mb-4 text-blue-700">상담 조언 받기</h2>
             <p class="mb-2 text-sm text-gray-500">학생의 고민 내용 (선택 사항)</p>
             <textarea id="teacher-edit-concern" rows="4" placeholder="예: '학교 시험만 보면 긴장해서 실력 발휘를 못해요.'" class="w-full p-4 rounded-xl border border-gray-300 bg-gray-50 focus:outline-none resize-none mb-4"></textarea>
             
             <p class="mb-2 text-sm text-gray-500">학생의 특성 (필수)</p>
             <textarea id="teacher-characteristic-textarea" rows="4" placeholder="예: 소심하고 내성적임, 끈기는 있으나 방법을 모름, 친구 관계에 어려움을 겪음" class="w-full p-4 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none mb-4"></textarea>

             <p class="mb-2 text-sm text-gray-500">생성된 상담 조언</p>
             <textarea id="teacher-edit-textarea" rows="6" class="w-full p-4 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none mb-4" readonly></textarea>
             <div class="flex flex-col sm:flex-row justify-between gap-2">
                 <button id="export-google-sheets-btn" class="w-full sm:w-1/3 mx-0 sm:mx-2 bg-gray-500 text-white font-bold py-3 rounded-xl hover:bg-gray-600 transition-colors shadow-lg">스프레드시트로 내보내기</button>
                 <button id="generate-teacher-advice-btn" class="w-full sm:w-1/3 ml-0 sm:ml-2 bg-blue-500 text-white font-bold py-3 rounded-xl hover:bg-blue-600 transition-colors shadow-lg">AI 조언 받기</button>
             </div>
        </div>

        <!-- 상담 결과 섹션 -->
        <div id="result-section" class="mt-8">
            <h2 class="text-xl font-semibold mb-4 text-blue-700">결과</h2>
            <div id="loading" class="hidden">
                <div class="loading-spinner"></div>
                <p class="text-center mt-4 text-gray-500">AI 조언을 생성하고 있어요...</p>
            </div>
            <div id="counseling-result" class="bg-blue-50 p-6 rounded-xl border border-blue-200 shadow-sm text-gray-700 leading-relaxed whitespace-pre-wrap">
                <!-- 결과 텍스트가 여기에 표시됩니다. -->
            </div>
            <div id="status-message" class="mt-4 p-4 rounded-xl text-center font-semibold hidden"></div>
        </div>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            
            const teacherEditConcern = document.getElementById('teacher-edit-concern');
            const teacherEditTextarea = document.getElementById('teacher-edit-textarea');
            const teacherCharacteristicTextarea = document.getElementById('teacher-characteristic-textarea');
            const exportGoogleSheetsBtn = document.getElementById('export-google-sheets-btn');
            const statusMessageDiv = document.getElementById('status-message');
            const generateTeacherAdviceBtn = document.getElementById('generate-teacher-advice-btn');
            const loadingSpinner = document.getElementById('loading');
            const counselingResultDiv = document.getElementById('counseling-result');

            // 상태 메시지를 표시하는 함수
            const displayStatusMessage = (message, colorClass) => {
                statusMessageDiv.textContent = message;
                statusMessageDiv.className = `mt-4 p-4 rounded-xl text-center font-semibold block ${colorClass}`;
                setTimeout(() => {
                    statusMessageDiv.classList.add('hidden');
                }, 5000);
            };

            // 구글 스프레드시트 내보내기 기능을 트리거하는 함수
            const exportDataToSheets = async () => {
                const EXPORT_URL = 'https://script.google.com/macros/s/AKfycbxxqltE-f6kd23xXISrnyrcArCDkWHNAdwduSHxz7uLd3OPn8cryfSHDyWz_jzQLirT/exec';
                
                const studentCharacteristics = teacherCharacteristicTextarea.value.trim();
                const counseling = teacherEditTextarea.value.trim();

                if (counseling.length === 0) {
                    displayStatusMessage('먼저 상담 내용을 입력하거나 AI 조언을 받아주세요.', 'bg-red-100 text-red-700');
                    return;
                }

                displayStatusMessage('데이터를 스프레드시트로 내보내고 있습니다. 잠시만 기다려주세요...', 'bg-gray-100 text-gray-700');
                
                // 전송할 데이터를 준비합니다. 수정된 상담 조언 내용을 포함합니다.
                const dataToExport = {
                    characteristics: studentCharacteristics,
                    counseling: counseling,
                };

                try {
                    const response = await fetch(EXPORT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(dataToExport),
                    });

                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        displayStatusMessage('데이터가 성공적으로 스프레드시트에 내보내졌습니다!', 'bg-green-100 text-green-700');
                    } else {
                        throw new Error(result.error || '내보내기 실패.');
                    }
                } catch (error) {
                    console.error('스프레드시트 내보내기 오류:', error);
                    displayStatusMessage(`스프레드시트 내보내기 실패: ${error.message}`, 'bg-red-100 text-red-700');
                }
            };

            // 선생님을 위한 AI 조언 생성 함수
            const generateTeacherAdvice = async () => {
                const studentCharacteristics = teacherCharacteristicTextarea.value.trim();
                const studentConcern = teacherEditConcern.value.trim();
                
                if (studentCharacteristics.length === 0) {
                    displayStatusMessage('학생의 특성 내용을 먼저 입력해주세요.', 'bg-red-100 text-red-700');
                    return;
                }

                displayStatusMessage('선생님을 위한 AI 조언을 생성하고 있어요...', 'bg-gray-100 text-gray-700');

                const systemPrompt = `
                    당신은 수년간 학생들을 상담해 온 베테랑 담임 교사입니다. 학생의 고민을 들었을 때, 선생님이 실제로 어떻게 대화하고 어떤 순서로 상담을 진행하는지 알려주세요. 딱딱한 교과서적인 조언 대신, 학생의 마음을 열 수 있는 진솔하고 실용적인 조언을 단계별로 제공해 주세요. 다음 내용을 포함해서 답변해 주세요:
                    - 학생에게 공감하며 대화를 시작하는 첫 멘트 (실제 예시 포함)
                    - 학생의 진짜 속마음을 파악하기 위한 질문법
                    - 학생이 스스로 고민을 해결할 힘을 키워주는 실질적인 방법
                    - 상담 중 절대로 하지 말아야 할 말이나 태도 (구체적인 예시 포함)
                    - 과거에 비슷한 고민을 했던 학생을 어떻게 도왔는지에 대한 경험담
                    - 마지막으로, 학생에게 진심을 담아 건넬 수 있는 격려의 한마디
                    편안하고 진심이 담긴 조언을 2~3개 정도의 문단으로 구성해 주세요.
                `;
                const userQuery = `학생의 특성: ${studentCharacteristics}\n학생의 고민: ${studentConcern}`;
                
                loadingSpinner.classList.remove('hidden');

                const maxRetries = 3;
                let currentRetry = 0;
                
                while (currentRetry < maxRetries) {
                    try {
                        const payload = {
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        };
                        const apiKey = "AKfycbxxqltE-f6kd23xXISrnyrcArCDkWHNAdwduSHxz7uLd3OPn8cryfSHDyWz_jzQLirT"; // 여기에 발급받은 Gemini API 키를 입력하세요.
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`API error: ${response.statusText}`);
                        }

                        const result = await response.json();
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (text) {
                            teacherEditTextarea.value = text;
                            counselingResultDiv.textContent = text;
                            displayStatusMessage('AI 조언이 생성되었습니다!', 'bg-green-100 text-green-700');
                            break;
                        } else {
                            throw new Error('No content returned from API.');
                        }

                    } catch (error) {
                        console.error('API 호출 실패:', error);
                        currentRetry++;
                        if (currentRetry >= maxRetries) {
                            displayStatusMessage('죄송합니다. AI 조언 생성에 실패했어요. 다시 시도해 주세요.', 'bg-red-100 text-red-700');
                        } else {
                            const delay = Math.pow(2, currentRetry) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                        }
                    }
                }
                
                loadingSpinner.classList.add('hidden');
            };
            
            exportGoogleSheetsBtn.addEventListener('click', exportDataToSheets);
            generateTeacherAdviceBtn.addEventListener('click', generateTeacherAdvice);
        });
    </script>
</body>
</html>
